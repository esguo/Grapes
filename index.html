<!DOCTYPE html>
<html>
<head>
  <title>IAATK Prototype for Autocomplete</title>
  <meta charset='utf-8' />
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <style>
  * {
    box-sizing: border-box;
  }
  body {
    font: 16px Arial;
  }
  input {
    border: 1px solid transparent;
    background-color: #f1f1f1;
    padding: 10px;
    font-size: 16px;
  }
</style>
</head>


<body>
  <p>Demo Autocomplete</p>

  <!--Add buttons to initiate auth sequence and sign out-->
  <button id="authorize-button" style="display: none;">Authorize</button>
  <button id="signout-button" style="display: none;">Sign Out</button>

  <pre id="content"></pre>

  <div class="ui-widget">
    <label for="name">Name: </label>
    <input id="name">
    <button id="submit-button" style="display: none;">Submit</button>
  </div>


  <!--Make sure the form has the autocomplete function switched off:-->
  <!-- <form autocomplete="off" action="/action_page.php">
    <div class="autocomplete" style="width:300px;">
      <input id="myInput" type="text" name="fName" placeholder="First Name">
    </div>
    <input type="submit">
  </form> -->

  <script type="text/javascript">
  // Client ID and API key from the Developer Console
  var CLIENT_ID = '19798527682-v5cu75u3b7499sk3u027926nps5br8l4.apps.googleusercontent.com';
  var API_KEY = 'AIzaSyCL7rRqEs2ol_KD8wzFiX0CoOZ5ZIIdP4g';

  //SPREADSHEET_ID needed for each google sheet -> this is the main sheet
  var SPREADSHEET_ID = '1YY9dLjVEgaYl9HAvre1MvUHQUyxsGjNoKgAxYIRAaIA';
  var SPREADSHEET_ATTN = '16pJeS9ADQ_aCkWni8WREvP3tIRNkoAVK0N4K-l5MCmo';
  //var SPREADSHEET_ID = '16pJeS9ADQ_aCkWni8WREvP3tIRNkoAVK0N4K-l5MCmo';

  // Array of API discovery doc URLs for APIs used by the quickstart
  var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

  // Authorization scopes required by the API; multiple scopes can be
  // included, separated by spaces.
  var SCOPES = "https://www.googleapis.com/auth/spreadsheets";

  var authorizeButton = document.getElementById('authorize-button');
  var signoutButton = document.getElementById('signout-button');
  var submitButton = document.getElementById('submit-button');

  /**
  *  On load, called to load the auth2 library and API client library.
  */
  function handleClientLoad() {
    gapi.load('client:auth2', initClient);
  }

  /**
  *  Initializes the API client library and sets up sign-in state
  *  listeners.
  */
  function initClient() {
    gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      discoveryDocs: DISCOVERY_DOCS,
      scope: SCOPES
    }).then(function () {
      // Listen for sign-in state changes.
      gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

      // Handle the initial sign-in state.
      updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
      authorizeButton.onclick = handleAuthClick;
      signoutButton.onclick = handleSignoutClick;
      submitButton.onclick = handleSubmitClick;
    });
  }

  /**
  *  Called when the signed in status changes, to update the UI
  *  appropriately. After a sign-in, the API is called.
  */
  function updateSigninStatus(isSignedIn) {
    if (isSignedIn) {
      authorizeButton.style.display = 'none';
      signoutButton.style.display = 'block';
      submitButton.style.display = 'block';
      getNames();
      // parseResult(result);
    } else {
      authorizeButton.style.display = 'block';
      signoutButton.style.display = 'none';
    }
  }

  /**
  *  Sign in the user upon button click.
  */
  function handleAuthClick(event) {
    gapi.auth2.getAuthInstance().signIn();
  }

  /**
  *  Sign out the user upon button click.
  */
  function handleSignoutClick(event) {
    gapi.auth2.getAuthInstance().signOut();
  }

   function handleSubmitClick(event) {
     updateSheet();
  }

  function updateSheet() {
    gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ATTN,
      range: 'A:A'
    }).then((response) => {
      var result = response.result;
      var numRows = result.values ? result.values.length + 1: 0;
      console.log(`${numRows} rows retrieved.`);

      var range = "A" + numRows + ":D" + numRows; //TODO change the range
      console.log("Range: " + range);
      write(range)

    });
  }
  function write(range){
    console.log('NAME VALUE' + document.getElementById('name').value);
    if(document.getElementById('name').value == ""){
      alert("Please enter a name");
      return;
    };

    gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ATTN,
      range: range,
      valueInputOption: 'USER_ENTERED',
      values: [[Date(), document.getElementById('name').value]]
      alert("Checked in!")
    }).then(function(response) {
      console.log(response);
    });
  }
  /**
  * Append a pre element to the body containing the given message
  * as its text node. Used to display the results of the API call.
  *
  * @param {string} message Text to be placed in pre element.
  */
  function appendPre(message) {
    var pre = document.getElementById('content');
    var textContent = document.createTextNode(message + '\n');
    pre.appendChild(textContent);
  }

  function parseResult(result){
    first = result.valueRanges[0].values.map(String);
    last = result.valueRanges[1].values.map(String);
    phone = result.valueRanges[2].values.map(String);

    var users = [];
    for (var i = 1; i < first.length; i++){
        users.push({value:first[i] + " " + last[i], Phone:phone[i]});
    }
    console.log(users);

    $( "#name" ).autocomplete({
      source: function(request, response){
        var matcher = new RegExp( $.ui.autocomplete.escapeRegex( request.term ), "i" );
        response($.grep(users, function(value) {
            return matcher.test(value.value) || matcher.test(value.Phone);
        }));
      }
    });
  }

  function getNames(){
    // Range names ...
    var ranges = [
      'Form Responses 1!B:B',
      'Form Responses 1!C:C',
      'Form Responses 1!D:D'
    ];
    gapi.client.sheets.spreadsheets.values.batchGet({
      spreadsheetId: SPREADSHEET_ID,
      ranges: ranges
    }).then((response) => {
      var result = response.result;
      parseResult(result);
      console.log(`${result.valueRanges[0].values} ranges retrieved.`);
    });
  }

  /**
  * Print the names and majors of students in a sample spreadsheet:
  * https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/edit
  */
  function listMajors() {
    gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: '1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms',
      range: 'Class Data!A2:E',
    }).then(function(response) {
      var range = response.result;
      if (range.values.length > 0) {
        appendPre('Name, Major:');
        for (i = 0; i < range.values.length; i++) {
          var row = range.values[i];
          // Print columns A and E, which correspond to indices 0 and 4.
          appendPre(row[0] + ', ' + row[4]);
        }
      } else {
        appendPre('No data found.');
      }
    }, function(response) {
      appendPre('Error: ' + response.result.error.message);
    });
  }


  </script>

  <script async defer src="https://apis.google.com/js/api.js"
  onload="this.onload=function(){};handleClientLoad()"
  onreadystatechange="if (this.readyState === 'complete') this.onload()">
  </script>


</body>
</html>
